version: '2'

services:
  printer:
    image: "${IMAGE}"
    entrypoint: lua print-results.lua
    environment:
      FROM: "tcp://routerreduceprinter:5562"
    env_file: global.env
    volumes:
      - "${VOLUME}"
    depends_on:
      - reduce
      - filter
      - mapper
      - data
      - routerreduceprinter
    networks:
      xp:
        aliases:
          - controller

  routerreduceprinter:
    image: "${IMAGE}"
    hostname: routerreduceprinter
    entrypoint: lua router.lua
    environment:
      TO: "tcp://*:5562"
      FROM: "tcp://*:5561"
    env_file: global.env
    volumes:
      - "${VOLUME}"
    networks:
      - xp

  reduce:
    image: "${IMAGE}"
    entrypoint: lua reduce-events.lua
    environment:
      TO: "tcp://routerreduceprinter:5561"
      FROM: "tcp://routerfilterreduce:5560"
    env_file: global.env
    volumes:
      - "${VOLUME}"
    depends_on:
      - routerreduceprinter
      - routerfilterreduce
    networks:
      - xp

  routerfilterreduce:
    image: "${IMAGE}"
    hostname: routerfilterreduce
    entrypoint: lua router.lua
    environment:
      TO: "tcp://*:5560"
      FROM: "tcp://*:5559"
    env_file: global.env
    volumes:
      - "${VOLUME}"
    networks:
      - xp

  filter:
    image: "${IMAGE}"
    entrypoint: lua filter-event.lua
    environment:
      TO: "tcp://routerfilterreduce:5559"
      FROM: "tcp://routermapperfilter:5558"
    env_file: global.env
    volumes:
      - "${VOLUME}"
    depends_on:
      - routerfilterreduce
      - routermapperfilter
    networks:
      - xp

  routermapperfilter:
    image: "${IMAGE}"
    hostname: routermapperfilter
    entrypoint: lua router.lua
    environment:
      TO: "tcp://*:5558"
      FROM: "tcp://*:5557"
    env_file: global.env
    volumes:
      - "${VOLUME}"
    networks:
      - xp

  mapper:
    image: "${IMAGE}"
    entrypoint: lua map-csv-to-event.lua
    environment:
      TO: "tcp://routermapperfilter:5557"
      FROM: "tcp://routerdatamapper:5556"
    env_file: global.env
    volumes:
      - "${VOLUME}"
    depends_on:
      - routermapperfilter
      - routerdatamapper
    networks:
      - xp

  routerdatamapper:
    image: "${IMAGE}"
    hostname: routerdatamapper
    entrypoint: lua router.lua
    environment:
      TO: "tcp://*:5556"
      FROM: "tcp://*:5555"
    env_file: global.env
    volumes:
      - "${VOLUME}"
    networks:
      - xp

  data:
    image: "${IMAGE}"
    entrypoint: lua data-stream.lua
    environment:
      TO: "tcp://routerdatamapper:5555"
    env_file: global.env
    volumes:
      - "${VOLUME}"
    depends_on:
      - routerdatamapper
    networks:
      - xp


networks:
  xp:
